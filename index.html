<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music MV Generator - Base64 Demo</title>

    <style>
        body { font-family: Arial; margin: 40px auto; width: 90%; max-width: 900px; line-height: 1.5; }
        textarea, input { width: 100%; padding: 10px; margin-top: 5px; font-size: 1rem; }
        button { padding: 12px 20px; font-size: 1rem; margin-top: 10px; cursor: pointer; }
        .section { padding: 20px; border: 1px solid #ddd; margin-top: 20px; border-radius: 10px; }
        .data-info { font-size: 0.8rem; color: #555; display: block; margin-top: 5px; }
    </style>
</head>

<body>

<h1>ğŸµ Music MV Generator (Base64 Demo)</h1>
<p>æ‰€æœ‰æª”æ¡ˆéƒ½ä»¥ Base64 ç·¨ç¢¼åœ¨ JSON å…§å‚³è¼¸ã€‚è«‹ç¢ºä¿ Colab å¾Œç«¯æ­£åœ¨é‹è¡Œã€‚</p>

<script>
/* ----------------------------------------
    Backend API (æ¯æ¬¡ Colab å•Ÿå‹•éƒ½éœ€æ›´æ–°æ­¤ç¶²å€!)
------------------------------------------ */
const BASE_API_URL = "https://coldturkey-ana-blackheartedly.ngrok-free.dev"; // <-- è«‹æ›¿æ›ç‚º Colab è¼¸å‡ºçš„ ngrok URL

// ç‹€æ…‹è¿½è¹¤è®Šæ•¸ (ç”¨æ–¼ä¸²æ¥æµç¨‹)
let lyricsContent = ""; // å­˜æ”¾æ­Œè©å…§å®¹ (æ–‡å­—)
let promptContent = ""; // å­˜æ”¾ Prompt å…§å®¹ (æ–‡å­—)
let imageBase64DataUrl = ""; // å­˜æ”¾ Step 3 è¿”å›çš„ Base64 Data URL (ä¾›é¡¯ç¤º)
let imageBase64String = ""; // å­˜æ”¾ Step 3 è¿”å›çš„ç´” Base64 å­—ä¸² (ä¾› Step 4 å‚³è¼¸)

/* ----------------------------------------
    é€šç”¨çš„å·¥å…·å‡½å¼
------------------------------------------ */
function getFileMimeType(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const mimeMap = {
        'txt': 'text/plain',
        'png': 'image/png',
        'mp4': 'video/mp4',
        'mp3': 'audio/mpeg',
    };
    return mimeMap[ext] || 'application/octet-stream';
}

function base64ToDataUrl(filename, base64String) {
    const mime = getFileMimeType(filename);
    return `data:${mime};base64,${base64String}`;
}

/* ----------------------------------------
    é€šç”¨çš„ Fetch å‡½å¼
------------------------------------------ */
async function apiFetch(endpoint, options) {
    const statusDiv = document.getElementById('status_message');
    statusDiv.textContent = `Processing ${endpoint}...`;
    statusDiv.style.color = 'blue';

    try {
        const res = await fetch(`${BASE_API_URL}${endpoint}`, options);
        const data = await res.json();
        
        if (res.status !== 200 || data.success === false) {
            statusDiv.textContent = `âŒ API Error (${endpoint}): ${data.error || 'Unknown server error'}`;
            statusDiv.style.color = 'red';
            return null;
        }
        
        statusDiv.textContent = `âœ… Success: ${endpoint}`;
        statusDiv.style.color = 'green';
        return data;
    } catch (e) {
        statusDiv.textContent = `âŒ Network Error: Cannot connect to Colab backend.`;
        statusDiv.style.color = 'red';
        return null;
    }
}


/* ----------------------------------------
    STEP 1: Audio â†’ Lyrics
------------------------------------------ */
async function step1_audio_to_lyrics() {
    const file = document.getElementById("audio_file").files[0];
    if (!file) return alert("Please upload an audio file");

    const fd = new FormData();
    fd.append("file", file);

    const data = await apiFetch("/audio_to_lyrics", { 
        method: "POST",
        body: fd
    });
    if (!data) return;

    // è§£ç¢¼ Base64 å…§å®¹ä¸¦å„²å­˜
    const base64Content = atob(data.base64); // è§£ç¢¼ Base64 å­—ä¸²
    lyricsContent = base64Content;
    document.getElementById("lyrics_output").value = lyricsContent;
    document.getElementById("lyrics_info").textContent = `Filename: ${data.filename}, Size: ${data.base64.length} bytes (Base64)`;
}


/* ----------------------------------------
    STEP 2: Lyrics â†’ Prompt
------------------------------------------ */
async function step2_lyrics_to_prompt() {
    const currentLyrics = document.getElementById("lyrics_output").value;
    if (!currentLyrics) return alert("No lyrics found! Please complete Step 1 or enter lyrics manually.");
    
    // å¾Œç«¯æ¥æ”¶çš„æ˜¯ FormData
    const fd = new FormData();
    fd.append("text", currentLyrics); // å¾Œç«¯æ˜¯ request.form["text"]

    const data = await apiFetch("/lyrics_to_prompts", { 
        method: "POST",
        body: fd
    });
    if (!data) return;

    // è§£ç¢¼ Base64 å…§å®¹ä¸¦å„²å­˜
    const base64Content = atob(data.base64);
    promptContent = base64Content;
    document.getElementById("prompt_output").value = promptContent;
    document.getElementById("prompt_info").textContent = `Filename: ${data.filename}, Size: ${data.base64.length} bytes (Base64)`;
}


/* ----------------------------------------
    STEP 3: Prompt â†’ Image
------------------------------------------ */
async function step3_prompt_to_image() {
    const currentPrompt = document.getElementById("prompt_output").value;
    if (!currentPrompt) return alert("No prompt! Please complete Step 2 or enter a prompt manually.");

    // å¾Œç«¯æ¥æ”¶çš„æ˜¯ FormData
    const fd = new FormData();
    fd.append("prompt", currentPrompt); // å¾Œç«¯æ˜¯ request.form["prompt"]

    const data = await apiFetch("/prompt_to_image", { 
        method: "POST",
        body: fd
    });
    if (!data) return;
    
    // å„²å­˜ Base64 å­—ä¸²å’Œ Data URL
    imageBase64String = data.base64; // ç´” Base64 å­—ä¸² (ç”¨æ–¼ Step 4 å‚³è¼¸)
    imageBase64DataUrl = base64ToDataUrl(data.filename, imageBase64String); // Data URL (ç”¨æ–¼é¡¯ç¤º)
    
    document.getElementById("generated_image").src = imageBase64DataUrl; 
    document.getElementById("image_info").textContent = `Filename: ${data.filename}, Size: ${imageBase64String.length} bytes (Base64)`;
}


/* ----------------------------------------
    STEP 4: Image â†’ Video
------------------------------------------ */
async function step4_image_to_video() {
    if (!imageBase64String) return alert("Please complete Step 3 first and generate an image.");
    
    // å°‡ Step 3 ç”Ÿæˆçš„åœ–ç‰‡ Base64 å­—ä¸²å‚³çµ¦å¾Œç«¯
    const fd = new FormData();
    // å¾Œç«¯æ¥æ”¶ request.form["image_base64"]
    fd.append("image_base64", imageBase64String); 

    const data = await apiFetch("/image_to_video", { 
        method: "POST",
        body: fd
    });
    if (!data) return;

    // å„²å­˜ Base64 å­—ä¸²å’Œ Data URL
    const videoBase64String = data.base64;
    const videoBase64DataUrl = base64ToDataUrl(data.filename, videoBase64String);
    
    document.getElementById("generated_video").src = videoBase64DataUrl;
    document.getElementById("video_info").textContent = `Filename: ${data.filename}, Size: ${videoBase64String.length} bytes (Base64)`;
}
</script>



<p id="status_message" style="margin-top: 10px; font-weight: bold;">è«‹æ›¿æ› API ç¶²å€ä¸¦é–‹å§‹é‹è¡Œ Colabã€‚</p>

<div class="section">
    <h2>Step 1 â€” Audio â†’ Lyrics</h2>
    <input type="file" id="audio_file" accept=".mp3,.wav,.m4a,.mp4">
    <button onclick="step1_audio_to_lyrics()">Convert to Lyrics</button>

    <h3>Lyrics Output</h3>
    <textarea id="lyrics_output" rows="8"></textarea>
    <span id="lyrics_info" class="data-info"></span>
</div>


<div class="section">
    <h2>Step 2 â€” Lyrics â†’ Prompt</h2>
    <button onclick="step2_lyrics_to_prompt()">Generate Prompt</button>

    <h3>Prompt Output</h3>
    <textarea id="prompt_output" rows="6"></textarea>
    <span id="prompt_info" class="data-info"></span>
</div>


<div class="section">
    <h2>Step 3 â€” Prompt â†’ Image</h2>
    <button onclick="step3_prompt_to_image()">Generate Image</button>

    <h3>Generated Image</h3>
    <img id="generated_image" width="100%">
    <span id="image_info" class="data-info"></span>
</div>


<div class="section">
    <h2>Step 4 â€” Image â†’ Video</h2>
    <button onclick="step4_image_to_video()">Generate Video</button>

    <h3>Generated Video</h3>
    <video id="generated_video" width="100%" controls></video>
    <span id="video_info" class="data-info"></span>
</div>

</body>
</html>